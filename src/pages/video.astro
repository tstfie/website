---
import "../styles/base.css"
import "../styles/global.css"
import "../styles/normalise.css"

import type { SanityDocument } from "@sanity/client";
import PortableText from "../components/PortableText.astro";
import { sanityClient } from "../lib/sanity";
import { urlForImage } from "../lib/url-for-image";;

import Header from '../layouts/header.astro';
import Head from '../layouts/head.astro';
import Footer from '../layouts/footer.astro';
import Image from "astro/components/Image.astro";


// ------------------------------
// Fetch page data
// ------------------------------

const entry = await sanityClient.fetch<{
  releaseDate: string;
  title: string;
  heading: string;
  paragraph?: string;
  image?: typeof Image;
  link?: string;
  linkTitle?: string;
}[]>(`
  *[_type == "audit"] | order(
    coalesce(work->releaseDate, releaseDate) desc
  ) {
    // Release date
    "releaseDate": coalesce(
      releaseDate,
      work->releaseDate
    ),

    // Preview title
    "title": coalesce(
      title,
      work->title
    ),

    // Opened-state heading
    "heading": coalesce(
      heading,
      work->type
    ),

    // Manual-only description
    paragraph,

    // Cover image
    "image": coalesce(
      image,
      work->cover
    ),

    // Correct production URL
    "link": coalesce(
      select(
        // MUSIC (anything that != collection)
        work->type != "Collection" =>
          "/music/" + work->slug.current,

        // COLLECTIONS â€” routed by release window
        work->type == "Collection" &&
        work->releaseDate >= "2023-06-01" &&
        work->releaseDate <= "2024-05-31" =>
          "/designs/23-24/" + work->slug.current,

        work->type == "Collection" &&
        work->releaseDate >= "2024-06-01" &&
        work->releaseDate <= "2025-05-31" =>
          "/designs/24-25/" + work->slug.current,

        work->type == "Collection" &&
        work->releaseDate >= "2025-06-01" &&
        work->releaseDate <= "2026-05-31" =>
          "/designs/25-26/" + work->slug.current
      ),
      link
    ),

    "linkTitle": coalesce(
      linkTitle,
      select(
        work->type == "Collection" => "View collection",
        work->type in ["Mixtape", "EP", "Single"] => "View project",
        true => null,
      ),
      )
  }
`);

// ------------------------------
// format release date
// ------------------------------
function formatDate(dateString: string) {
  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2, "0");
  const month = String(date.getMonth() + 1).padStart(2, "0"); // months are 0-indexed
  const year = String(date.getFullYear()).slice(-2); // last 2 digits

  return `${day}/${month}/${year}`;
}

---
<html lang="en">
<Head
  title="tstfie"
  description="Niklay Wiborny, for tstfie."
  canonical="https://www.tstfie.ch/"/>
    <body>
        <container class="padding">
            <div id="source" style="display:none; margin-left:auto; margin-right:auto;">
            <Image class="box blank" data-weight="100" src="/video/CD.png" alt="" width="125" height="125"/>
            <Image class="box phase-3" data-weight="1" src="/video/VINYL.png" alt="" width="125" height="125"/>
            <Image class="box phase-1 phase-2 phase-3 phase-4" data-weight="8" src="/video/CIRCOFIFTHS-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-2 phase-3 phase-4" data-weight="6" src="/video/CIRCOFIFTHS-VINYL.png" alt="" width="125" height="125" />
            <Image class="box phase-1 phase-2 phase-3 phase-4" data-weight="4" src="/video/SPIRITS-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-2 phase-3 phase-4" data-weight="1" src="/video/SPIRITS-LEGACY.png" alt="" width="125" height="125" />
            <Image class="box phase-2 phase-3 phase-4" data-weight="5" src="/video/SAINTIFICATION-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-3 phase-4" data-weight="6" src="/video/HOMES-CD.png" alt="" width="125" height="125" />
{/*            <Image class="box" data-weight="1" src="/video/SHIRT.png" alt="" width="125" height="125" />
            <Image class="box" data-weight="1" src="/video/BLACK-SHIRT.png" alt="" width="125" height="125" /> */}
            <Image class="box phase-3 phase-4" data-weight="2" src="/video/MOMENTIUM.png" alt="" width="81" height="112" style="padding:22px; margin-bottom:-50px;"/>
            <Image class="box phase-3 phase-4" data-weight="1" src="/video/SO BEST BELIEVE.png" alt="" width="81" height="112" style="padding:22px; margin-bottom:-50px;"/>
            <Image class="box phase-3 phase-4" data-weight="2" src="/video/NVM eXPRESS.png" alt="" width="81" height="112" style="padding:22px; margin-bottom:-50px;"/>
            <Image class="box phase-3" data-weight="5" src="/video/THEDOCUMENTARY-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-3 phase-4" data-weight="5" src="/video/INTERLUDES-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-3 phase-4" data-weight="5" src="/video/INTERLUDIUMAR-CD.png" alt="" width="125" height="125" />
            <Image class="box phase-2 phase-3 phase-4" data-weight="3" src="/video/Apogee.png" alt="" width="81" height="112" style="padding:22px; margin-bottom:-50px;"/>
            <Image class="box phase-4" data-weight="2" src="/video/SHIRT.png" alt="" width="81" height="112" style="padding:22px; margin-bottom:-50px;"/>
            <Image class="box phase-4" data-weight="5" src="/video/TESTIFY-CD.png" alt="" width="125" height="125" />
            <Image class="box blank-2" data-weight="100" src="/video/PHASE-5.png" alt="" width="125" height="125" />
            </div>

            <div id="stream" class="hflex" style="flex-wrap:wrap; align-content:center; margin-left:auto; margin-right:auto;"></div>
            {/*// Header //*/}
            <Header>
            <a href="/about" class="navigation">Info</a>
            <div class="projects-nav">
                <a href="#projects" class="navigation view-projects">View projects</a>
                <div class="projects-links">
                <a href="/designs" class="navigation">Designs</a>
                <a href="/music" class="navigation">Music</a>
                </div>
            </div>
            </Header>
            {/*// Main content //*/}
            <section class="window" style="padding-bottom:1450px;">
            <main class="audit-log" id="projects">
                <article class="audit-log-entry" data-open="false">
                    <header class="log-entry-preview">
                    <p class="meta number">11/01/26</p>
                    <h3><span class="link">www.tstfie.ch</span></h3>
                    </header>
                </article>
            </main>
            </section>
            {/*// Footer component //*/}
            <Footer/>
        </container>
        <script>
        // ==========================
        // Base asset collection
        // ==========================

        const allBoxes = Array.from(
            document.querySelectorAll<HTMLElement>('#source .box')
        );

        const stream = document.getElementById('stream');
        if (!stream) throw new Error('Missing #stream');

        function pickRandom<T>(arr: T[]): T {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // ==========================
        // Asset selection helper
        // ==========================

        function selectByClasses(classes: string[]): HTMLElement[] {
            return allBoxes.filter(el =>
            classes.some(cls => el.classList.contains(cls))
            );
        }

        // ==========================
        // Phase definitions
        // ==========================

        const phases = [
            {
            items: 100, // Act I
            blankBurst: [12, 20],
            interruptionChance: 0.05,
            allowDouble: false,
            activeClasses: ['blank', 'phase-1']
            },
            {
            items: 200, // Act II
            blankBurst: [6, 10],
            interruptionChance: 0.35,
            allowDouble: false,
            activeClasses: ['blank', 'phase-1', 'phase-2']
            },
            {
            items: 150, // Act III
            blankBurst: [2, 5],
            interruptionChance: 0.55,
            allowDouble: true,
            activeClasses: ['blank', 'phase-1', 'phase-2', 'phase-3']
            },
            {
            items: 100, // Act IV
            blankBurst: [0, 1],
            interruptionChance: 0.75,
            allowDouble: true,
            activeClasses: ['blank', 'phase-1', 'phase-2', 'phase-3', 'phase-4']
            },
            {
            items: 40, // Act V
            blankBurst: [1],
            interruptionChance: 0.8,
            allowDouble: true,
            activeClasses: ['blank', 'blank-2', 'phase-1', 'phase-5']
            },
            {
            items: 25, // Act VI
            blankBurst: [1],
            interruptionChance: 0.8,
            allowDouble: true,
            activeClasses: ['blank', "blank-2"]
            }
        ];

        // ==========================
        // Generator
        // ==========================

        for (const phase of phases) {
            let remainingInBurst = 0;

            const allowedAssets = selectByClasses(phase.activeClasses);
            const blanks = allowedAssets.filter(el =>
            el.classList.contains('blank')
            );
            const others = allowedAssets.filter(el =>
            !el.classList.contains('blank')
            );

            if (!allowedAssets.length) continue;

            for (let i = 0; i < phase.items; i++) {
            let chosen: HTMLElement;

            if (remainingInBurst > 0 && blanks.length) {
                chosen = pickRandom(blanks);
                remainingInBurst--;
            } else if (
                others.length &&
                Math.random() < phase.interruptionChance
            ) {
                chosen = pickRandom(others);

                if (phase.allowDouble && Math.random() < 0.25) {
                stream.appendChild(chosen.cloneNode(true));
                }

                const [min, max] = phase.blankBurst;
                remainingInBurst =
                min + Math.floor(Math.random() * (max - min + 1));
            } else {
                chosen = pickRandom(blanks.length ? blanks : others);
            }

            stream.appendChild(chosen.cloneNode(true));
            }
        }
        </script>
    </body>
</html>