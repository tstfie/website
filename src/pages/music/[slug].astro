---
import "../../styles/base.css"
import "../../styles/global.css"
import "../../styles/normalise.css"

import { sanityClient } from "../../lib/sanity";
import { urlForImage } from "../../lib/url-for-image";;

import Header from '../../layouts/header.astro';
import Head from '../../layouts/head.astro';
import Footer from '../../layouts/footer.astro'

// ------------------------------
// 1️⃣ Define static paths
// ------------------------------
export async function getStaticPaths() {
  const slugs: { slug: string }[] = await sanityClient.fetch(`
    *[_type == "work" && type != "Collection"]{
      "slug": slug.current
    }
  `);

  return slugs.map(({ slug }) => ({
    params: { slug },
  }));
}

// ------------------------------
// 2️⃣ Fetch page data
// ------------------------------
const { slug } = Astro.params;

const project = await sanityClient.fetch<{
  title: string;
  type: string;
  slug?: { current: string };
  releaseDate: string;
  length: string;
  cover: any;

  links?: {
    streaming?: {
      label: string;
      url: string;
    }[];
    download?: string;
  };

  tracklists: {
    title: string;
    tracks: {
      title: string;
      duration: string;
      order: number;
      artists: {
        name: string;
      }[];
    }[];
  }[];
} | null>(`
  *[_type == "work" && slug.current == $slug && type != "Collection"][0]{
    type,
    title,
    slug,
    releaseDate,
    length,
    cover,
    links{
      streaming[]{
        label,
        url
      },
      download
    },
    tracklists[]{
      title,
      tracks[]->{
        title,
        duration,
        order,
        artists[]->{
          name
        }
      }
    }
  }
`, { slug });

if (!project) {
  throw new Error(`Project not found for slug: ${slug}`);
}

// ------------------------------
// 3️⃣ Optional: format release date
// ------------------------------
function formatDate(dateString: string) {
  const date = new Date(dateString);
  const day = date.getDate();
  const month = date.toLocaleString("en-GB", { month: "long" });
  const year = date.getFullYear();

  let ordinal = "th";
  if (day % 10 === 1 && day !== 11) ordinal = "st";
  else if (day % 10 === 2 && day !== 12) ordinal = "nd";
  else if (day % 10 === 3 && day !== 13) ordinal = "rd";

  return `${month} ${day}${ordinal}, ${year}`;
}

const pageTitle = project.title
---

<html lang = en>
<Head
  title={project.title}
  description="pending"
  canonical="https://tstfie.ch/"
/>
<body>
  <div class="padding">
    <Header>
      <a onclick="history.back()" class="navigation">Back</a>
    </Header>
    <section class="window music">
      <main>
        <div class="project-header">
          <img src={urlForImage(project.cover).width(1200).url()} loading="lazy" alt="" class="project-cover">
          <h1>{project.title}</h1>
          <p class="meta">{formatDate(project.releaseDate)} — {project.length}</p>
        </div>
      </main>
      <section class="section">
        <div class="interaction-wrapper h4 stream-group">

          <a class="cta primary dropdown stream-trigger">Stream</a>

          {project.links?.streaming?.map((service, index) => {
            const letter = String.fromCharCode(97 + index);

            return (
              <a
                href={service.url}
                class={`cta primary dropdown option ${letter}`}
                data-stream-option
                target="_blank"
                rel="noopener"
              >
                {service.label}
              </a>
            );
          })}

          {project.links?.download && (
            <a href={project.links.download} class="cta">Download</a>
          )}

        </div>
        {project.tracklists.map((list) => (
          <div class="tracklist">{list.title && <h3>{list.title}</h3>}
          {list.tracks.map((track) =>
            <div class="track">
              <div class="meta number">{track.order.toString().padStart(2, "0")}</div>
              <div class="track-title">
                <div class="title">{track.title}</div>
                <div class="meta">{track.artists.map(a => a.name).join(", ")}</div>
              </div>
              <div class="meta number">{track.duration}</div>
              <div>...</div>
            </div>
        )}
          </div>
        ))}

      </section>
      <section class="section">
        <div class="meta">{project.releaseDate}</div>
        <div class="meta">{project.length}</div>
        <div class="w-layout-hflex interaction-wrapper credits">
          <div class="meta">@{new Date(project.releaseDate).getFullYear()} Niklay Wiborny, for tstfie</div>
        </div>
      </section>
    </section>
    <Footer/>
  </div>

<script is:inline>
const streamGroups = document.querySelectorAll('.stream-group');

streamGroups.forEach(group => {
  const trigger = group.querySelector('.stream-trigger');
  const options = group.querySelectorAll('[data-stream-option]');

  if (!trigger || options.length === 0) return;

  let closeTimeout = null;
  let isOpen = false;

  const openMenu = () => {
    clearTimeout(closeTimeout);
    options.forEach(option => {
      option.style.display = 'inline-flex';
    });
    isOpen = true;
  };

  const closeMenu = (delay = 150) => {
    clearTimeout(closeTimeout);
    closeTimeout = setTimeout(() => {
      options.forEach(option => {
        option.style.display = 'none';
      });
      isOpen = false;
    }, delay);
  };

  /* Desktop hover */
  trigger.addEventListener('mouseenter', openMenu);
  group.addEventListener('mouseleave', () => closeMenu(400));

  /* Mobile / touch */
  trigger.addEventListener('click', (e) => {
    e.preventDefault();

    if (isOpen) {
      closeMenu(0);
    } else {
      openMenu();
    }
  });

  /* Optional: close when clicking a stream option */
  options.forEach(option => {
    option.addEventListener('click', () => {
      closeMenu(0);
    });
  });
});
</script>
</body>
</html>