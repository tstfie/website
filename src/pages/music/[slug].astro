---
import "../../styles/base.css"
import "../../styles/global.css"
import "../../styles/normalise.css"

import { sanityClient } from "../../lib/sanity";
import { urlForImage } from "../../lib/url-for-image";

import Header from '../../layouts/header.astro';
import Head from '../../layouts/head.astro';
import Footer from '../../layouts/footer.astro'

// ------------------------------
// 1️⃣ Static paths
// ------------------------------
export async function getStaticPaths() {
  const slugs: { slug: string }[] = await sanityClient.fetch(`
    *[_type == "work" && type != "Collection"]{
      "slug": slug.current
    }
  `);

  return slugs.map(({ slug }) => ({
    params: { slug },
  }));
}

// ------------------------------
// 2️⃣ Fetch page data
// ------------------------------
const { slug } = Astro.params;

const project = await sanityClient.fetch<{
  title: string;
  type: string;
  slug?: { current: string };
  releaseDate: string;
  lengthDisplay: string;
  durationMinutes?: number;
  durationSeconds?: number;
  cover: any;
  links?: {
    streaming?: { label: string; url: string }[];
    download?: string;
  };
  tracklists: {
    title: string;
    tracks: {
      title: string;
      duration: string;
      order: number;
      artists: { name: string }[];
    }[];
  }[];
} | null>(`
  *[_type == "work" && slug.current == $slug && type != "Collection"][0]{
    type,
    title,
    slug,
    releaseDate,
    lengthDisplay,
    durationMinutes,
    durationSeconds,
    cover,
    links{
      streaming[]{ label, url },
      download
    },
    tracklists[]{
      title,
      tracks[]->{
        title,
        duration,
        order,
        artists[]->{ name }
      }
    }
  }
`, { slug });


if (!project) {
  throw new Error(`Project not found for slug: ${slug}`);
}

// ------------------------------
// 3️⃣ Helpers
// ------------------------------
function formatDate(dateString: string) {
  const date = new Date(dateString);
  const day = date.getDate();
  const month = date.toLocaleString("en-GB", { month: "long" });
  const year = date.getFullYear();

  let ordinal = "th";
  if (day % 10 === 1 && day !== 11) ordinal = "st";
  else if (day % 10 === 2 && day !== 12) ordinal = "nd";
  else if (day % 10 === 3 && day !== 13) ordinal = "rd";

  return `${month} ${day}${ordinal}, ${year}`;
}

// FIX: parse display-only string safely for schema
function toISODuration(input?: string) {
  if (!input) return undefined;

  const minutes = input.match(/(\d+)\s*min/);
  const seconds = input.match(/(\d+)\s*sec/);

  if (!minutes && !seconds) return undefined;

  return `PT${minutes ? minutes[1] + "M" : ""}${seconds ? seconds[1] + "S" : ""}`;
}
---

<html lang="en">
<Head
  title={project.title}
  description={`${project.type} by Niklay — ${formatDate(project.releaseDate)}`}
  canonical={`https://tstfie.ch/${project.slug?.current}`}
/>

<!-- FIX: Structured data -->
<script type="application/ld+json">
{JSON.stringify({
  "@context": "https://schema.org",
  "@type": "MusicAlbum",
  "name": project.title,
  "url": `https://tstfie.ch/${project.slug?.current}`,
  "datePublished": project.releaseDate,
  "byArtist": {
    "@type": "Person",
    "name": "Niklay"
  },
  "numTracks": project.tracklists?.[0]?.tracks?.length,
  "duration": `PT${project.durationMinutes ?? 0}M${project.durationSeconds ?? 0}S`, // <-- comma here
  "track": project.tracklists?.[0]?.tracks?.map(track => ({
    "@type": "MusicRecording",
    "position": track.order,
    "name": track.title,
    "byArtist": track.artists?.map(a => ({
      "@type": "Person",
      "name": a.name
    }))
  })),
  "sameAs": project.links?.streaming?.map(s => s.url)
}, null, 2)}
</script>


<body>
  <div class="padding">
    <Header>
      <a onclick="history.back()" class="navigation">Back</a>
    </Header>

    <section class="window music">
      <main>
        <div class="project-header">
          <img src={urlForImage(project.cover).width(1200).url()} loading="lazy" alt="" class="project-cover"/>
          <h1>{project.title}</h1>
          <p class="meta">
            {formatDate(project.releaseDate)} — {project.lengthDisplay}
          </p>
        </div>
      </main>

      <section class="section">
        <div class="interaction-wrapper h4 stream-group">
          <a class="cta primary dropdown stream-trigger">Stream</a>

          {project.links?.streaming?.map((service, index) => (
            <a
              href={service.url}
              class={`cta primary dropdown option ${String.fromCharCode(97 + index)}`}
              data-stream-option
              target="_blank"
              rel="noopener"
            >
              {service.label}
            </a>
          ))}

          {project.links?.download && (
            <a href={project.links.download} class="cta">Download</a>
          )}
        </div>

        {project.tracklists.map(list => (
          <div class="tracklist">
            {list.title && <h3>{list.title}</h3>}
            {list.tracks.map(track => (
              <div class="track">
                <div class="meta number">{track.order.toString().padStart(2, "0")}</div>
                <div class="track-title">
                  <div class="title">{track.title}</div>
                  <div class="meta">{track.artists.map(a => a.name).join(", ")}</div>
                </div>
                <div class="meta number">{track.duration}</div>
                <div>…</div>
              </div>
            ))}
          </div>
        ))}
      </section>

      <section class="section">
        <div class="meta">{formatDate(project.releaseDate)}</div>
        <div class="meta">
          {project.durationMinutes ?? 0} minutes, 
          {project.durationSeconds ? ` ${project.durationSeconds} seconds` : ""}
        </div>
        <div class="meta">
          © {new Date(project.releaseDate).getFullYear()} Niklay Wiborny, for tstfie
        </div>
      </section>
    </section>

    <Footer />
  </div>
</body>
</html>
